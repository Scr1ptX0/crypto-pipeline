"""
ETL Pipeline –¥–ª—è –∑–±–æ—Ä—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ CoinGecko API
"""
from datetime import datetime, timedelta
import json
import pandas as pd
import requests
import psycopg2
from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.operators.bash import BashOperator

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
COINGECKO_API_URL = "https://api.coingecko.com/api/v3"
TOP_CRYPTOS = ['bitcoin', 'ethereum', 'binancecoin', 'solana', 'cardano', 
               'dogecoin', 'polygon', 'avalanche-2', 'chainlink', 'uniswap']

# Default arguments
default_args = {
    'owner': 'data-engineer',
    'depends_on_past': False,
    'start_date': datetime(2025, 1, 1),
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 2,
    'retry_delay': timedelta(minutes=5),
}

# DAG definition
dag = DAG(
    'crypto_data_pipeline',
    default_args=default_args,
    description='ETL pipeline –¥–ª—è –∑–±–æ—Ä—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö',
    schedule_interval=timedelta(hours=1),  # –ó–∞–ø—É—Å–∫ —â–æ–≥–æ–¥–∏–Ω–∏
    catchup=False,
    tags=['crypto', 'etl', 'production'],
)

def extract_crypto_prices(**context):
    """
    –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ü—ñ–Ω–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –∑ CoinGecko API
    """
    print("üîÑ –ü–æ—á–∏–Ω–∞—î–º–æ –∑–±—ñ—Ä –¥–∞–Ω–∏—Ö –∑ CoinGecko API...")
    
    try:
        # –ó–∞–ø–∏—Ç –¥–æ API –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–∏–Ω–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        url = f"{COINGECKO_API_URL}/coins/markets"
        params = {
            'vs_currency': 'usd',
            'order': 'market_cap_desc',
            'per_page': 50,
            'page': 1,
            'sparkline': 'false',
            'price_change_percentage': '1h,24h,7d'
        }
        
        print(f"üì° –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –¥–æ: {url}")
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        print(f"‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ –¥–ª—è {len(data)} –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç")
        
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ raw –¥–∞–Ω—ñ —É —Ñ–∞–π–ª
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        raw_file_path = f"/opt/airflow/data/raw/crypto_prices_{timestamp}.json"
        
        with open(raw_file_path, 'w') as f:
            json.dump(data, f, indent=2)
        
        print(f"üíæ Raw –¥–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤: {raw_file_path}")
        
        # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–¥–∞—á
        return {
            'raw_file_path': raw_file_path,
            'records_count': len(data),
            'extraction_time': timestamp
        }
        
    except requests.exceptions.RequestException as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ –¥–æ API: {e}")
        raise
    except Exception as e:
        print(f"‚ùå –ù–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")
        raise

def transform_crypto_data(**context):
    """
    –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
    """
    print("üîÑ –ü–æ—á–∏–Ω–∞—î–º–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö...")
    
    # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –∑–∞–¥–∞—á—ñ
    ti = context['ti']
    extract_result = ti.xcom_pull(task_ids='extract_crypto_prices')
    raw_file_path = extract_result['raw_file_path']
    
    print(f"üìÇ –ß–∏—Ç–∞—î–º–æ –¥–∞–Ω—ñ –∑: {raw_file_path}")
    
    # –ß–∏—Ç–∞—î–º–æ raw –¥–∞–Ω—ñ
    with open(raw_file_path, 'r') as f:
        raw_data = json.load(f)
    
    # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î–º–æ –¥–∞–Ω—ñ
    transformed_records = []
    
    for coin in raw_data:
        try:
            record = {
                'coin_id': coin['id'],
                'symbol': coin['symbol'].upper(),
                'name': coin['name'],
                'current_price': float(coin['current_price']) if coin['current_price'] else None,
                'market_cap': int(coin['market_cap']) if coin['market_cap'] else None,
                'market_cap_rank': int(coin['market_cap_rank']) if coin['market_cap_rank'] else None,
                'total_volume': float(coin['total_volume']) if coin['total_volume'] else None,
                'price_change_24h': float(coin['price_change_24h']) if coin['price_change_24h'] else None,
                'price_change_percentage_24h': float(coin['price_change_percentage_24h']) if coin['price_change_percentage_24h'] else None,
                'price_change_percentage_7d': float(coin.get('price_change_percentage_7d_in_currency')) if coin.get('price_change_percentage_7d_in_currency') else None,
                'circulating_supply': float(coin['circulating_supply']) if coin['circulating_supply'] else None,
                'total_supply': float(coin['total_supply']) if coin['total_supply'] else None,
                'ath': float(coin['ath']) if coin['ath'] else None,
                'ath_date': coin['ath_date'],
                'atl': float(coin['atl']) if coin['atl'] else None,
                'atl_date': coin['atl_date'],
                'last_updated': coin['last_updated'],
                'extraction_timestamp': datetime.now().isoformat()
            }
            transformed_records.append(record)
            
        except (KeyError, ValueError, TypeError) as e:
            print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –º–æ–Ω–µ—Ç–∏ {coin.get('id', 'unknown')}: {e}")
            continue
    
    print(f"‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ {len(transformed_records)} –∑–∞–ø–∏—Å—ñ–≤")
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ
    timestamp = extract_result['extraction_time']
    processed_file_path = f"/opt/airflow/data/processed/crypto_prices_transformed_{timestamp}.json"
    
    with open(processed_file_path, 'w') as f:
        json.dump(transformed_records, f, indent=2)
    
    print(f"üíæ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤: {processed_file_path}")
    
    return {
        'processed_file_path': processed_file_path,
        'transformed_records_count': len(transformed_records),
        'processing_time': timestamp
    }

def load_to_database(**context):
    """
    –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ PostgreSQL
    """
    print("üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –¥–æ PostgreSQL...")
    
    # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –∑–∞–¥–∞—á—ñ
    ti = context['ti']
    transform_result = ti.xcom_pull(task_ids='transform_crypto_data')
    processed_file_path = transform_result['processed_file_path']
    
    # –ß–∏—Ç–∞—î–º–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ
    with open(processed_file_path, 'r') as f:
        data = json.load(f)
    
    print(f"üìä –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ {len(data)} –∑–∞–ø–∏—Å—ñ–≤ –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö...")
    
    try:
        # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
        conn = psycopg2.connect(
            host="project-postgres",
            database="crypto_db",
            user="crypto_user",
            password="crypto_pass",
            port=5432
        )
        cursor = conn.cursor()
        
        # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
        create_table_sql = """
        CREATE TABLE IF NOT EXISTS crypto_prices (
            id SERIAL PRIMARY KEY,
            coin_id VARCHAR(100) NOT NULL,
            symbol VARCHAR(10) NOT NULL,
            name VARCHAR(100) NOT NULL,
            current_price DECIMAL(20,8),
            market_cap BIGINT,
            market_cap_rank INTEGER,
            total_volume DECIMAL(20,2),
            price_change_24h DECIMAL(20,8),
            price_change_percentage_24h DECIMAL(10,4),
            price_change_percentage_7d DECIMAL(10,4),
            circulating_supply DECIMAL(25,2),
            total_supply DECIMAL(25,2),
            ath DECIMAL(20,8),
            ath_date TIMESTAMP,
            atl DECIMAL(20,8),
            atl_date TIMESTAMP,
            last_updated TIMESTAMP,
            extraction_timestamp TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        """
        
        cursor.execute(create_table_sql)
        print("‚úÖ –¢–∞–±–ª–∏—Ü—è crypto_prices –≥–æ—Ç–æ–≤–∞")
        
        # –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö
        insert_sql = """
        INSERT INTO crypto_prices (
            coin_id, symbol, name, current_price, market_cap, market_cap_rank,
            total_volume, price_change_24h, price_change_percentage_24h,
            price_change_percentage_7d, circulating_supply, total_supply,
            ath, ath_date, atl, atl_date, last_updated, extraction_timestamp
        ) VALUES (
            %(coin_id)s, %(symbol)s, %(name)s, %(current_price)s, %(market_cap)s,
            %(market_cap_rank)s, %(total_volume)s, %(price_change_24h)s,
            %(price_change_percentage_24h)s, %(price_change_percentage_7d)s,
            %(circulating_supply)s, %(total_supply)s, %(ath)s, %(ath_date)s,
            %(atl)s, %(atl_date)s, %(last_updated)s, %(extraction_timestamp)s
        )
        """
        
        cursor.executemany(insert_sql, data)
        conn.commit()
        
        print(f"‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ {len(data)} –∑–∞–ø–∏—Å—ñ–≤ –¥–æ —Ç–∞–±–ª–∏—Ü—ñ crypto_prices")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        cursor.execute("SELECT COUNT(*) FROM crypto_prices")
        total_records = cursor.fetchone()[0]
        print(f"üìä –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ –≤ —Ç–∞–±–ª–∏—Ü—ñ: {total_records}")
        
        cursor.close()
        conn.close()
        
        return {
            'loaded_records': len(data),
            'total_records_in_db': total_records,
            'load_timestamp': datetime.now().isoformat()
        }
        
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ –ë–î: {e}")
        if 'conn' in locals():
            conn.rollback()
            conn.close()
        raise

def generate_summary_report(**context):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–≤—ñ—Ç—É –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è pipeline
    """
    print("üìä –ì–µ–Ω–µ—Ä—É—î–º–æ –∑–≤—ñ—Ç...")
    
    ti = context['ti']
    extract_result = ti.xcom_pull(task_ids='extract_crypto_prices')
    transform_result = ti.xcom_pull(task_ids='transform_crypto_data')
    load_result = ti.xcom_pull(task_ids='load_to_database')
    
    report = {
        'pipeline_execution_time': datetime.now().isoformat(),
        'extraction': {
            'records_extracted': extract_result['records_count'],
            'extraction_time': extract_result['extraction_time']
        },
        'transformation': {
            'records_transformed': transform_result['transformed_records_count'],
            'processing_time': transform_result['processing_time']
        },
        'loading': {
            'records_loaded': load_result['loaded_records'],
            'total_records_in_db': load_result['total_records_in_db'],
            'load_timestamp': load_result['load_timestamp']
        }
    }
    
    print("="*50)
    print("üìà –ó–í–Ü–¢ –í–ò–ö–û–ù–ê–ù–ù–Ø CRYPTO DATA PIPELINE")
    print("="*50)
    print(f"üïê –ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: {report['pipeline_execution_time']}")
    print(f"üì• –ó—ñ–±—Ä–∞–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: {report['extraction']['records_extracted']}")
    print(f"üîÑ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ: {report['transformation']['records_transformed']}")
    print(f"üíæ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤ –ë–î: {report['loading']['records_loaded']}")
    print(f"üìä –ó–∞–≥–∞–ª–æ–º –≤ –ë–î: {report['loading']['total_records_in_db']}")
    print("="*50)
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–≤—ñ—Ç
    timestamp = extract_result['extraction_time']
    report_file_path = f"/opt/airflow/data/processed/pipeline_report_{timestamp}.json"
    
    with open(report_file_path, 'w') as f:
        json.dump(report, f, indent=2)
    
    print(f"üìÑ –ó–≤—ñ—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤: {report_file_path}")
    
    return report

# –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞–¥–∞—á
start_task = BashOperator(
    task_id='start_pipeline',
    bash_command='echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ Crypto Data Pipeline..."',
    dag=dag,
)

extract_task = PythonOperator(
    task_id='extract_crypto_prices',
    python_callable=extract_crypto_prices,
    dag=dag,
)

transform_task = PythonOperator(
    task_id='transform_crypto_data',
    python_callable=transform_crypto_data,
    dag=dag,
)

load_task = PythonOperator(
    task_id='load_to_database',
    python_callable=load_to_database,
    dag=dag,
)

report_task = PythonOperator(
    task_id='generate_summary_report',
    python_callable=generate_summary_report,
    dag=dag,
)

end_task = BashOperator(
    task_id='end_pipeline',
    bash_command='echo "‚úÖ Crypto Data Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"',
    dag=dag,
)

# –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (–ø–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)
start_task >> extract_task >> transform_task >> load_task >> report_task >> end_task